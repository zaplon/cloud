<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="CDA_PL_IG_1.3.1.xsl" type="text/xsl"?>
<ClinicalDocument xsi:type="extPL:ClinicalDocument" xmlns="urn:hl7-org:v3"
                  xmlns:extPL="http://www.csioz.gov.pl/xsd/extPL/r2" xmlns:pharm="urn:ihe:pharm"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <!-- Dokument recepty na lek OTC-->
    <typeId extension="POCD_HD000040" root="2.16.840.1.113883.1.3"/>
    <templateId root="1.3.6.1.4.1.19376.1.9.1.1.1"/>
    <templateId root="1.3.6.1.4.1.19376.1.5.3.1.1.1"/>
    <templateId root="2.16.840.1.113883.3.4424.13.10.1.3" extension="1.3.1"/>

    <id extension="{{lek.numer_recepty}}" root="{{podmiot.id_lokalne}}.2.1" displayable="true"/>
    <code code="57833-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
          displayName="Prescription for medication Document">
        <translation code="04.01" codeSystem="2.16.840.1.113883.3.4424.11.1.32" codeSystemName="KLAS_DOK_P1"
                     displayName="Recepta">po
            <qualifier>
                <name code="KDLEK" codeSystem="2.16.840.1.113883.3.4424.13.5.1"
                      codeSystemName="PolskieKlasyfikatoryHL7v3" displayName="Kategoria dostępności leku"/>
                <value code="Rp" codeSystem="2.16.840.1.113883.3.4424.11.1.25"/>
            </qualifier>
            <qualifier>
                <name code="RLEK" codeSystem="2.16.840.1.113883.3.4424.13.5.1"
                      codeSystemName="PolskieKlasyfikatoryHL7v3" displayName="Rodzaj leku"/>
                {% if lek.jest_recepturowy %}
                <value code="R" codeSystem="2.16.840.1.113883.3.4424.13.5.1" displayName="Lek recepturowy"/>
                {% else %}
                <value code="G" codeSystem="2.16.840.1.113883.3.4424.13.5.1" displayName="Lek gotowy"/>
                {% endif %}
            </qualifier>
            <qualifier>
                <name code="TWREC" codeSystem="2.16.840.1.113883.3.4424.13.5.1"
                      codeSystemName="PolskieKlasyfikatoryHL7v3" displayName="Tryb wystawienia recepty"/>
                <value code="Z" displayName="Zwykła" codeSystem="2.16.840.1.113883.3.4424.13.5.1"/>
            </qualifier>
            <qualifier>
                <name code="TRREC" codeSystem="2.16.840.1.113883.3.4424.13.5.1"
                      codeSystemName="PolskieKlasyfikatoryHL7v3" displayName="Tryb realizacji recepty"/>
                <value code="Z" displayName="Zwykły" codeSystem="2.16.840.1.113883.3.4424.13.5.1"/>
            </qualifier>
        </translation>
    </code>
    <title>Recepta</title>
    <effectiveTime value="{{recepta.data_wystawienia}}"/>
    <confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25"/>
    <languageCode code="pl-PL"/>
    <setId extension="432231" root="2.16.840.1.113883.3.4424.7.2.2"/>
    <versionNumber value="1"/>
    {% include 'parts/record_target.xml' %}
    {% include 'parts/no_refundation/author.xml' %}
    {% include 'parts/custodian.xml' %}
    {% include 'parts/legal_authenticator.xml' %}
    <component>
        <templateId root="2.16.840.1.113883.3.4424.13.10.2.25"/>
        <structuredBody>
            {% if lek.jest_recepturowy %}
            {% include 'parts/lek_recepturowy.xml' %}
            {% else %}
            {% include 'parts/lek_gotowy.xml' %}
            {% endif %}
            {% if recepta.uprawnienia_dodatkowe %}
            <component>
                <section>
                    <templateId root="2.16.840.1.113883.10.20.1.9"/>
                    <templateId root="1.3.6.1.4.1.19376.1.5.3.1.1.5.3.7"/>
                    <templateId root="2.16.840.1.113883.3.4424.13.10.3.69"/>
                    <code code="48768-6" codeSystem="2.16.840.1.113883.6.1"/>
                    <title>Dane o ubezpieczeniu i uprawnieniach</title>
                    <text>
                        <paragraph ID="ACT_2">Oddział NFZ: {{ recepta.oddzial_nfz }}
                            <br/>
                            Uprawnienia dodatkowe: {{ recepta.uprawnienia_dodatkowe }}
                        </paragraph>
                    </text>
                    <entry>
                        <act classCode="ACT" moodCode="DEF">
                            <templateId root="2.16.840.1.113883.10.20.1.20"/>
                            <templateId root="2.16.840.1.113883.3.4424.13.10.4.51"/>
                            <id nullFlavor="NA"/>
                            <code code="48768-6" codeSystem="2.16.840.1.113883.6.1" displayName="Payment source"/>
                            <text>
                                <reference value="#ACT_2"/>
                            </text>
                            <statusCode code="completed"/>
                            <entryRelationship typeCode="COMP">
                                <act classCode="ACT" moodCode="EVN"> <!-- Uprawnienie dodatkowe -->
                                    <templateId root="2.16.840.1.113883.10.20.1.26"/>
                                    <templateId root="2.16.840.1.113883.3.4424.13.10.4.61"/>
                                    <id nullFlavor="NA"/>
                                    <code code="PUBLICPOL" codeSystem="2.16.840.1.113883.5.4">
                                        <qualifier>
                                            <name code="RLUD" codeSystem="2.16.840.1.113883.3.4424.13.5.1" displayName="Refundacja leków wynikająca z uprawnień dodatkowych"/>
                                            <value code="IB" displayName="IB" codeSystem="2.16.840.1.113883.3.4424.11.3.1"/>
                                        </qualifier>
                                    </code>
                                    <text>
                                        <reference value="#ACT_2"/>
                                    </text>
                                    <statusCode code="completed"/>
                                    <performer typeCode="PRF"> <!-- Dane ubezpieczyciela/płatnika -->
                                        <assignedEntity>
                                            <id extension="{{ recepta.oddzial_nfz }}" root="2.16.840.1.113883.3.4424.3.1" displayable="true"/>
                                        </assignedEntity>
                                    </performer>
                                    <entryRelationship typeCode="REFR">
                                        <act classCode="ACT" moodCode="EVN">
                                            <templateId root="2.16.840.1.113883.10.20.1.19"/>
                                            <templateId root="2.16.840.1.113883.3.4424.13.10.4.53"/>
                                            <id nullFlavor="NA"/>
                                            <code nullFlavor="NA"/>
                                            <entryRelationship typeCode="SUBJ">
                                                <substanceAdministration classCode="SBADM" moodCode="PRMS">
                                                    <id extension="2345678-1" root="{{podmiot.id_lokalne}}"/>
                                                    <consumable>
                                                        <manufacturedProduct>
                                                            <manufacturedMaterial nullFlavor="NA"/>
                                                        </manufacturedProduct>
                                                    </consumable>
                                                </substanceAdministration>
                                            </entryRelationship>
                                        </act>
                                    </entryRelationship>
                                    <reference typeCode="REFR">
                                        <externalDocument classCode="DOC"
                                                          moodCode="EVN"> <!-- Informacja o dokumencie potwierdzającym uprawnienie dodatkowe -->
                                            <templateId root="2.16.840.1.113883.3.4424.13.10.4.59"/>
                                            <text>{{ recepta.uprawnienia_dodatkowe }}</text>
                                        </externalDocument>
                                    </reference>
                                </act>
                            </entryRelationship>
                        </act>
                    </entry>
                </section>
            </component>
            {% endif %}
        </structuredBody>
    </component>
</ClinicalDocument>
